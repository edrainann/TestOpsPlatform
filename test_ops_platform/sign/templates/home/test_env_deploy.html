{% extends 'home/base_home.html' %}
{% load staticfiles %}
{% block title %}æµ‹è¯•ç¯å¢ƒéƒ¨ç½²{% endblock %}

{#{% block css %}#}
{#    <!-- Select2 -->#}
{#    <link rel="stylesheet" href="{% static 'admin_lte/plugins/select2/css/select2.min.css' %}">#}
{#{% endblock %}#}

{% block content_header %}æµ‹è¯•ç¯å¢ƒéƒ¨ç½²{% endblock %}
<!-- å†…éƒ¨å°è£… -->
{% block content %}

    <!-- Main content -->
    <section class="content">
        <!-- container-fluid -->
        <div class="container-fluid">

            <div class="row">
                <!-- å·¦è¾¹åˆ— -->
                <div class="col-md-4">

                    <!-- å¡ç‰‡ä¸»ä½“ -->
                    <div class="card card-default">
                        <!-- å¡ç‰‡å¤´éƒ¨ -->
                        <div class="card-header">
                            <h3 class="card-title">æ‰“åŒ…éƒ¨ç½²</h3>
                        </div><!-- /.å¡ç‰‡å¤´éƒ¨ -->

                        <!-- å¡ç‰‡å†…å®¹ -->
                        <div class="card-body">
                            {% csrf_token %}

                            <!-- é€‰æ‹©ç¯å¢ƒ -->
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">é€‰æ‹©ç¯å¢ƒï¼š</label>
                                <div class="col-sm-8">
                                    <select class="form-control" name="env_name" id="id_env_name">
                                        {% for item in env_name_list %}
                                            <option>{{ item.env_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div><!-- /.é€‰æ‹©ç¯å¢ƒ -->

                            <!-- é¡¹ç›®åç§° -->
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">é¡¹ç›®åç§°ï¼š</label>
                                <div class="col-sm-8">
                                    <select class="form-control select2" name="project_name"
                                            id="id_project_name" style="width: 100%;">
                                        <option disabled="disabled">è¯·é€‰æ‹©é¡¹ç›®åç§°</option>
                                        {% for item in project_name_list %}
                                            <option>{{ item.project_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div><!-- /.é¡¹ç›®åç§° -->

                            <!-- å½“å‰ç‰ˆæœ¬å· -->
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label" for="id_current_version_number">å½“å‰ç‰ˆæœ¬ï¼š</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input class="form-control " id="id_current_version_number"
                                               name="current_version_number" placeholder="æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬å·..." disabled/>
                                        <div class="input-group-prepend">
                                            <button type="button" class="btn btn-info float-right"
                                                    id="id_test_env_deploy_check_out_version_button">æŸ¥çœ‹
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- /.å½“å‰ç‰ˆæœ¬å· -->


                            <!-- ç‰ˆæœ¬å· -->
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label" for="id_version_number">ç‰ˆæœ¬å·ï¼š</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="id_version_number"
                                           name="version_number" placeholder="ä¸å¡«åˆ™é»˜è®¤ä¸ºå½“å‰ç‰ˆæœ¬update..."/>
                                </div>
                            </div><!-- /.ç‰ˆæœ¬å· -->

                            <!-- æ‰§è¡Œæ“ä½œ -->
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">æ‰§è¡Œæ“ä½œï¼š</label>
                                <div class="col-sm-8">
                                    <select class="form-control" name="deploy_execute_action"
                                            id="id_deploy_execute_action">
                                        {% for item in deploy_execute_action_list %}
                                            <option>{{ item.execute_action }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div><!-- /.æ‰§è¡Œæ“ä½œ -->

                        </div><!-- /.å¡ç‰‡å†…å®¹ -->

                        <div class="card-footer">
                            <button type="button" class="btn btn-primary float-right"
                                    id="id_test_env_deploy_execute_button">æ‰§è¡Œ
                            </button>
                        </div>


                    </div><!-- /.å¡ç‰‡ä¸»ä½“ -->

                </div><!--/.å·¦è¾¹åˆ— -->

                <!-- å³è¾¹åˆ— -->
                <div class="col-md-8">

                    <!-- å¡ç‰‡ä¸»ä½“ -->
                    <div class="card card-secondary">
                        <!-- å¡ç‰‡å¤´éƒ¨ -->
                        <div class="card-header">
                            <h3 class="card-title">æ‰§è¡Œç»“æœ</h3>
                        </div><!-- /.å¡ç‰‡å¤´éƒ¨ -->

                        <!-- æ˜¾ç¤ºæ‰§è¡Œç»“æœ -->
                        <div class="form-group">
                            <textarea id="id_test_env_deploy_execute_message"
                                      name="test_env_deploy_execute_message"
                                      class="form-control " rows="14"
                                      placeholder="æ˜¾ç¤ºæ‰§è¡Œç»“æœ......"
                                      disabled></textarea>
                        </div><!-- /.æ˜¾ç¤ºæ‰§è¡Œç»“æœ -->

                    </div><!-- /.å¡ç‰‡ä¸»ä½“ -->

                </div><!-- /.å³è¾¹åˆ— -->

            </div><!-- /.row -->

        </div><!-- /.container-fluid -->

    </section><!-- /.content -->


{% endblock %}
<!-- /.å†…éƒ¨å°è£… -->


<!-- jsåŠ¨æ€åŠ è½½å— -->
{% block js %}
    <!-- Select2 -->
    <script src="{% static 'admin_lte/plugins/select2/js/select2.full.min.js' %}"></script>
    <script>
        $(function () {
            //Initialize Select2 Elements,ä¸‹æ‹‰æ¡†å†…å¯ä»¥è¾“å…¥æ–‡å­—
            $('.select2').select2();
        });
    </script>

    <!-- ä¾§è¾¹æ å˜äº® -->
    <script type="text/javascript"> //é»˜è®¤çš„typeå°±æ˜¯JavaScriptï¼Œæ‰€ä»¥ä¸å¿…æ˜¾å¼åœ°æŠŠtypeæŒ‡å®šä¸ºJavaScript
    const element = document.getElementById("id_test_env_deploy");
    element.classList.add("active")
    </script><!-- /.ä¾§è¾¹æ å˜äº® -->

    <!-- å½“å‰ç‰ˆæœ¬æŸ¥çœ‹ -->
    <script>
        $(function () {
            $('#id_test_env_deploy_check_out_version_button').click(function () {
                /*åˆ›å»ºsocketè¿æ¥*/
                const socket = new WebSocket("ws://" + window.location.host + "/test_env_deploy/test_env_deploy_check_out_version");
                console.log("this is:" + socket);
                socket.onopen = function () {
                    console.log('WebSocket open');//æˆåŠŸè¿æ¥ä¸ŠWebsocket
                    const id_env_name = $('#id_env_name').val();
                    const id_project_name = $('#id_project_name').val();
                    const mess = id_env_name + '###' + id_project_name;
                    socket.send(mess);
                };
                socket.onmessage = function (e) {
                    // æ­£åˆ™åŒ¹é…å‡ºç¬¦åˆçš„æ–‡å­—
                    let ini_data = e.data.toString();
                    const reg = RegExp(/\[32m/);
                    if (reg.exec(ini_data)) {
                        const execute_message1 = e.data.replace('[m', ' ');
                        const execute_message = execute_message1.replace('[32m', ' ');
                        {#$('#id_current_version_number').val(execute_message);#}  //èµ‹å€¼ç»™inputï¼Œè¿™ç§å†™æ³•æœ‰æ—¶ä¼šå¤±æ•ˆ,ç‰¹åˆ«æ˜¯ä»–çš„çˆ¶å…ƒç´ æ˜¯dosplay:noneæ—¶
                        $('#id_current_version_number').attr("value", execute_message);
                        console.log("lalala", execute_message);
                    }
                    let execute_message1 = e.data.replace('[m', ' ');
                    let execute_message2 = execute_message1.replace('[31m', ' ');
                    let execute_message = execute_message2.replace('[32m', ' ');
                    console.log('message: ' + execute_message);//æ‰“å°æœåŠ¡ç«¯è¿”å›çš„æ•°æ®`
                    {#console.log('message: ' + e.data);//æ‰“å°æœåŠ¡ç«¯è¿”å›çš„æ•°æ®#}
                    {#$('#id_test_env_deploy_execute_message').append(e.data + '<br/>');#}
                    {#$('#id_current_version_number').append(execute_message + '\n');#}
                    $('#id_test_env_deploy_execute_message').append(execute_message + '\n');
                    let textarea = document.getElementById('id_test_env_deploy_execute_message');
                    textarea.scrollTop = textarea.scrollHeight;
                };
                socket.onclose = function (e) {
                    socket.close();
                    console.log('websocketå·²å…³é—­');
                    console.log(e);
                };

            });
        });
    </script><!-- /.å½“å‰ç‰ˆæœ¬æŸ¥çœ‹ -->

    <!-- update/newæŸ¥çœ‹ -->
    <script>
        $(function () {
            $('#id_test_env_deploy_execute_button').click(function () {
                /*åˆ›å»ºsocketè¿æ¥*/
                const socket = new WebSocket("ws://" + window.location.host + "/test_env_deploy/test_env_deploy_execute/");
                console.log("this is:" + socket);
                socket.onopen = function () {
                    console.log('WebSocket open');//æˆåŠŸè¿æ¥ä¸ŠWebsocket
                    const id_env_name = $('#id_env_name').val();
                    const id_project_name = $('#id_project_name').val();
                    const id_version_number = $('#id_version_number').val();
                    const id_deploy_execute_action = $('#id_deploy_execute_action').val();
                    const mess = id_env_name + '###' + id_project_name + '###' + id_version_number + '###' + id_deploy_execute_action;
                    socket.send(mess);
                };
                socket.onmessage = function (e) {
                    let execute_message1 = e.data.replace('[m', ' ');
                    let execute_message2 = execute_message1.replace('[31m', ' ');
                    let execute_message = execute_message2.replace('[32m', ' ');
                    console.log('message: ' + execute_message);//æ‰“å°æœåŠ¡ç«¯è¿”å›çš„æ•°æ®
                    $('#id_test_env_deploy_execute_message').append(execute_message + '\n');
                    {#$('#id_test_env_deploy_execute_message').append(e.data + '<br/>');#}
                    const textarea = document.getElementById('id_test_env_deploy_execute_message');
                    textarea.scrollTop = textarea.scrollHeight;
                };
            });
        });
    </script><!-- /.update/newæŸ¥çœ‹ -->


{% endblock %}